# yaml-language-server: $schema=https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/schemas/v3.0/schema.json
openapi: 3.0.3
info:
  title: Linux File Magic API
  version: 1.5.2
  description: >
    REST API for libmagic analysis on Linux x86_64.
    - **Protocol:** Versioned URI paths (/v1).
    - **Security:** Strict relative path validation and 100MB body limit.
    - **Tracing:** X-Request-ID included in all JSON responses.
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.example.com
    description: Production server

security:
  - basicAuth: []

paths:
  /v1/magic/content:
    post:
      operationId: analyzeMagicContent
      summary: Analyze via raw octet-stream (v1)
      description: >
        Analyzes binary content. The server handles the request body based on its size and transfer encoding:
        - **Chunked Transfer Encoding:** Content is streamed and written to a temporary file for analysis.
        - **Content-Length > threshold:** If the `Content-Length` exceeds the configured `large_file_threshold_mb`, the content is streamed and written to a temporary file.
        - **Content-Length <= threshold:** For smaller, non-chunked requests, the content is held in memory for analysis.
        Threshold is configurable (default: 10MB). Max body limit is 100MB.
      parameters:
        - in: query
          name: filename
          required: true
          schema:
            $ref: '#/components/schemas/WindowsCompatibleFilename'
          example: "analysis_data.bin"
      requestBody:
        required: true
        description: Raw binary data (Max 100MB).
        content:
          application/octet-stream:
            schema:
              type: string
              format: binary
      responses:
        '200':
          $ref: '#/components/responses/MagicResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '413':
          $ref: '#/components/responses/PayloadTooLarge'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/magic/path:
    post:
      operationId: analyzeMagicPath
      summary: Analyze via local relative path (v1)
      parameters:
        - in: query
          name: filename
          required: true
          schema:
            $ref: '#/components/schemas/WindowsCompatibleFilename'
        - in: query
          name: path
          required: true
          schema:
            $ref: '#/components/schemas/RelativePath'
      responses:
        '200':
          $ref: '#/components/responses/MagicResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /v1/ping:
    get:
      operationId: healthCheck
      summary: Health check
      security: []
      responses:
        '200':
          description: pong
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "pong" }
                  request_id: { $ref: '#/components/schemas/RequestId' }
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  securitySchemes:
      basicAuth:
        type: http
        scheme: basic
        description: >
          Standard HTTP Basic Authentication. 
          Credentials should be sent in the 'Authorization' header.
  schemas:
    RequestId:
      type: string
      format: uuid
      example: "550e8400-e29b-41d4-a716-446655440000"

    WindowsCompatibleFilename:
      type: string
      # Windows MAX_PATH (260) + 50 = 310
      maxLength: 310 
      pattern: '^[^/\0]+$'
      description: >
        UTF-8 encoded filename. 
        **Note:** This API intentionally accepts filenames that violate standard 
        Windows filesystem constraints. It allows up to 310 characters (exceeding 
        the 260-character MAX_PATH) and does not restrict Windows-reserved 
        characters, as the underlying platform is Linux.

    RelativePath:
      type: string
      pattern: '^(?!\/)(?!.*(\.\.|\.\/|\/\/))(?!\.$)[^ ].*$'
      description: Relative path (no traversal allowed).

    MagicResult:
      type: object
      required: [request_id, filename, result]
      properties:
        request_id: { $ref: '#/components/schemas/RequestId' }
        filename: { type: string }
        result:
          type: object
          properties:
            mime_type: { type: string }
            description: { type: string }
      example:
        request_id: "550e8400-e29b-41d4-a716-446655440000"
        filename: "example_file.dat"
        result:
          mime_type: "application/octet-stream"
          description: "data"

  responses:
    MagicResponse:
      description: Success
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/MagicResult'
    
    BadRequest:
      description: Bad Request - Invalid parameters or malformed request
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Invalid filename parameter" }
              request_id: { $ref: '#/components/schemas/RequestId' }
    
    Unauthorized:
      description: Unauthorized - Authentication required or failed
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Authentication required" }
              request_id: { $ref: '#/components/schemas/RequestId' }
    
    NotFound:
      description: Not Found - File path does not exist
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "File not found" }
              request_id: { $ref: '#/components/schemas/RequestId' }
    
    PayloadTooLarge:
      description: Payload Too Large - Request body exceeds 100MB limit
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Request body exceeds 100MB limit" }
              request_id: { $ref: '#/components/schemas/RequestId' }
    
    InternalServerError:
      description: Internal Server Error - Unexpected server error
      content:
        application/json:
          schema:
            type: object
            properties:
              error: { type: string, example: "Internal server error" }
              request_id: { $ref: '#/components/schemas/RequestId' }
